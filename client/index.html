<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chore Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pantone564: '#4F9A94',
            pantone604: '#E8BBE8'
          }
        }
      }
    };
  </script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body class="bg-gradient-to-br from-pantone604/10 to-pantone564/10 min-h-screen flex items-center justify-center">
  <div id="root" class="w-full"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function Auth({ onLogin }) {
      const [regUser, setRegUser] = useState('');
      const [regPass, setRegPass] = useState('');
      const [logUser, setLogUser] = useState('');
      const [logPass, setLogPass] = useState('');

      async function register() {
        await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: regUser, password: regPass })
        });
        alert('Registered! Please login.');
      }

      async function login() {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: logUser, password: logPass })
        });
        const data = await res.json();
        if (data.token) {
          localStorage.setItem('token', data.token);
          onLogin(data.token);
        } else {
          alert('Login failed');
        }
      }

      return (
        <div className="max-w-md w-full p-6 bg-white rounded shadow space-y-6">
          <h1 className="text-2xl font-bold text-center text-pantone564">Chore Tracker</h1>
          <div>
            <h2 className="font-semibold mb-2">Register</h2>
            <input value={regUser} onChange={e => setRegUser(e.target.value)} placeholder="Username" className="border p-2 w-full rounded" />
            <input type="password" value={regPass} onChange={e => setRegPass(e.target.value)} placeholder="Password" className="border p-2 w-full rounded mt-2" />
            <button onClick={register} className="bg-pantone564 text-white rounded p-2 w-full mt-2">Register</button>
          </div>
          <div>
            <h2 className="font-semibold mb-2">Login</h2>
            <input value={logUser} onChange={e => setLogUser(e.target.value)} placeholder="Username" className="border p-2 w-full rounded" />
            <input type="password" value={logPass} onChange={e => setLogPass(e.target.value)} placeholder="Password" className="border p-2 w-full rounded mt-2" />
            <button onClick={login} className="bg-pantone564 text-white rounded p-2 w-full mt-2">Login</button>
          </div>
        </div>
      );
    }

    function ChoreTracker({ token, onLogout }) {
      const [newChore, setNewChore] = useState('');
      const [chores, setChores] = useState([]);
      const [assignments, setAssignments] = useState([]);
      const [suggestions, setSuggestions] = useState([]);
      const weekdays = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];

      useEffect(() => { loadData(); }, []);

      async function loadData() {
        const res = await fetch('/api/logs/all', { headers: { 'Authorization': 'Bearer ' + token } });
        const logs = await res.json();
        const chSet = new Set();
        const map = {};
        logs.forEach(l => {
          chSet.add(l.chore);
          const day = new Date(l.ts).toLocaleDateString('en-US', { weekday: 'long' });
          const key = l.chore + '|' + day;
          if (!map[key]) {
            map[key] = { choreId: l.chore, day, users: [] };
          }
          const abbrev = l.user.slice(0,3);
          if (!map[key].users.includes(abbrev)) map[key].users.push(abbrev);
        });
        setChores(Array.from(chSet));
        setAssignments(Object.values(map));
      }

      async function addChore() {
        if (!newChore.trim()) return;
        await fetch('/api/chores', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ name: newChore.trim() })
        });
        setNewChore('');
        loadData();
      }

      useEffect(() => {
        if (!newChore.trim()) { setSuggestions([]); return; }
        fetch('/api/chores/autocomplete?q=' + encodeURIComponent(newChore.trim()), {
          headers: { 'Authorization': 'Bearer ' + token }
        }).then(r => r.json()).then(setSuggestions);
      }, [newChore]);

      const getUsersForChoreAndDay = (chore, day) => {
        const a = assignments.find(x => x.choreId === chore && x.day === day);
        return a ? a.users : [];
      };

      return (
        <div className="p-6 max-w-7xl mx-auto">
          <div className="mb-6 bg-white rounded shadow p-4">
            <h2 className="text-lg font-bold text-pantone564 mb-3">Chore Tracker</h2>
            <div className="flex gap-2 flex-wrap items-center">
              <input
                list="chore-suggestions"
                className="flex-1 border p-2 rounded"
                placeholder="Enter chore name..."
                value={newChore}
                onChange={e => setNewChore(e.target.value)}
                onKeyDown={e => e.key === 'Enter' && addChore()}
              />
              <datalist id="chore-suggestions">
                {suggestions.map(name => <option key={name} value={name} />)}
              </datalist>
              <button className="bg-pantone564 hover:bg-pantone564/90 text-white px-3 py-2 rounded" onClick={addChore}>Add</button>
              <button className="bg-gray-300 hover:bg-gray-400 text-black px-3 py-2 rounded" onClick={onLogout}>Logout</button>
            </div>
          </div>

          <div className="bg-white rounded shadow p-4 overflow-x-auto">
            <h3 className="text-lg font-bold text-pantone564 mb-3">Weekly Overview</h3>
            <div className="grid grid-cols-8 gap-2 min-w-[800px]">
              <div className="font-semibold p-3 text-center">Chores</div>
              {weekdays.map(day => (
                <div key={day} className="font-semibold p-3 text-center border-b bg-pantone604/30 text-pantone564">{day}</div>
              ))}
              {chores.map(chore => (
                <div key={chore} className="contents">
                  <div className="font-medium p-3 border-r bg-pantone564/20 flex items-center text-pantone564">{chore}</div>
                  {weekdays.map(day => (
                    <div key={chore + '-' + day} className="p-2 border min-h-[80px]">
                      <div className="flex flex-wrap gap-1">
                        {getUsersForChoreAndDay(chore, day).map(user => (
                          <span key={user} className="bg-pantone564 text-white text-xs px-1 rounded">{user}</span>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function App() {
      const [token, setToken] = useState(localStorage.getItem('token') || '');
      const logout = () => { localStorage.removeItem('token'); setToken(''); };

      return token ? <ChoreTracker token={token} onLogout={logout} /> : <Auth onLogin={setToken} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
